#!/bin/bash
# Wrapper for MarkHub

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PORT_FILE="$SCRIPT_DIR/.markhub-port"

# Show help
show_help() {
    cat << EOF
MarkHub - Markdown viewer with GitHub styling

Usage: markhub [OPTIONS] [FILE|URL]

Options:
  -h, --help       Show this help message
  -r, --restart    Restart the server (kill existing and start new)
  -s, --stop       Stop the running server
  -p, --port       Show the current server port
  -v, --version    Show version information

Examples:
  markhub                           Start server and open home page
  markhub README.md                 Open a markdown file
  markhub ~/Documents/notes.md      Open file with absolute path
  markhub https://gist.github.com/...  Open a Gist URL
  markhub -r                        Restart the server
  markhub -s                        Stop the server
  markhub -p                        Show current port

EOF
    exit 0
}

# Stop server
stop_server() {
    if [ -f "$PORT_FILE" ]; then
        PORT=$(cat "$PORT_FILE")
        echo "Stopping MarkHub server on port $PORT..."
        pkill -f "node.*server.js"
        rm -f "$PORT_FILE"
        echo "Server stopped."
    else
        echo "No server is currently running."
    fi
    exit 0
}

# Show port
show_port() {
    if [ -f "$PORT_FILE" ]; then
        PORT=$(cat "$PORT_FILE")
        if check_server "$PORT"; then
            echo "MarkHub is running on port $PORT"
            echo "URL: http://localhost:$PORT"
        else
            echo "Port file exists but server is not responding."
            rm -f "$PORT_FILE"
        fi
    else
        echo "No server is currently running."
    fi
    exit 0
}

if ! command -v node &> /dev/null; then
    echo "Error: node could not be found"
    exit 1
fi

# Function to check if server is running on a given port
check_server() {
    local port=$1
    curl -s "http://localhost:$port" > /dev/null 2>&1
    return $?
}

# Function to open URL in browser
open_url() {
    local port=$1
    local arg=$2
    
    if [ -z "$arg" ]; then
        open "http://localhost:$port"
    elif [ -f "$arg" ]; then
        # It's a file path - convert to absolute path
        local abs_path=$(cd "$(dirname "$arg")" && pwd)/$(basename "$arg")
        open "http://localhost:$port/local?file=$(node -e "console.log(encodeURIComponent('$abs_path'))")"
    else
        # Assume it's a URL
        open "http://localhost:$port/view?url=$(node -e "console.log(encodeURIComponent('$arg'))")"
    fi
}

# Parse command-line arguments
RESTART=false
NO_BROWSER=false
FILE_OR_URL=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            ;;
        -r|--restart)
            RESTART=true
            shift
            ;;
        -s|--stop)
            stop_server
            ;;
        -p|--port)
            show_port
            ;;
        -v|--version)
            echo "MarkHub v1.0.0"
            exit 0
            ;;
        --no-browser)
            NO_BROWSER=true
            shift
            ;;
        *)
            FILE_OR_URL="$1"
            shift
            ;;
    esac
done

# Handle restart
if [ "$RESTART" = true ]; then
    if [ -f "$PORT_FILE" ]; then
        PORT=$(cat "$PORT_FILE")
        echo "Restarting MarkHub server (was on port $PORT)..."
        pkill -f "node.*server.js"
        rm -f "$PORT_FILE"
        sleep 1
    else
        echo "No server running, starting new server..."
    fi
    # Start new server
    cd "$SCRIPT_DIR"
    node server.js "$FILE_OR_URL"
    exit 0
fi

# Check if server is already running
if [ -f "$PORT_FILE" ]; then
    PORT=$(cat "$PORT_FILE")
    if check_server "$PORT"; then
        if [ "$NO_BROWSER" = false ]; then
            echo "Using existing MarkHub server on port $PORT"
            open_url "$PORT" "$FILE_OR_URL"
        else
            echo "MarkHub server running on port $PORT"
        fi
        exit 0
    else
        # Port file exists but server isn't running, clean up
        rm -f "$PORT_FILE"
    fi
fi

# Start new server
cd "$SCRIPT_DIR"
if [ "$NO_BROWSER" = true ]; then
    MARKHUB_NO_BROWSER=1 node server.js "$FILE_OR_URL"
else
    node server.js "$FILE_OR_URL"
fi
